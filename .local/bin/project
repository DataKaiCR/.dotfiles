#!/usr/bin/env bash
# Project CLI - Manage and query project metadata
# Usage: project <command> [args]

set -e

VERSION="1.0.0"
PROJECTS_DIR="$HOME/projects"
ARCHIVE_DIR="$HOME/archive"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Helper functions
print_error() { echo -e "${RED}Error: $1${NC}" >&2; }
print_success() { echo -e "${GREEN}$1${NC}"; }
print_info() { echo -e "${CYAN}$1${NC}"; }
print_warning() { echo -e "${YELLOW}$1${NC}"; }

# Show usage
show_usage() {
    cat << EOF
Project CLI v${VERSION} - Manage and query project metadata

Usage:
    project <command> [options]

Commands:
    list [filter]           List all projects with optional filter
                           Filters: active, archived, datakai, westmonroe, product, client-project

    show <name>            Show detailed metadata for a project

    search <query>         Search projects by name, description, or tech stack

    find <tech>            Find projects using specific technology

    clients                List all client projects grouped by client

    stats                  Show project statistics

    validate [project]     Validate .project.toml files

    new <name>             Create new project with metadata template

    archive <name>         Move project to archive and update status

    edit <name>            Open project metadata in editor

    help                   Show this help message

Examples:
    project list active
    project show cert-study-platform
    project search databricks
    project find python
    project clients
    project new my-new-project

EOF
}

# Find all projects with .project.toml
find_all_projects() {
    find "$PROJECTS_DIR" "$ARCHIVE_DIR" -maxdepth 2 -name ".project.toml" 2>/dev/null | \
        sed 's|/.project.toml||' | \
        sort
}

# Get metadata field from TOML file
get_field() {
    local file="$1"
    local field="$2"
    grep "^$field = " "$file" 2>/dev/null | sed "s/$field = \"\(.*\)\"/\1/" || echo ""
}

# List projects with optional filter
cmd_list() {
    local filter="${1:-all}"
    local count=0

    print_info "=== Projects ($filter) ==="
    echo ""

    while IFS= read -r project_path; do
        toml="$project_path/.project.toml"

        name=$(get_field "$toml" "name")
        status=$(get_field "$toml" "status")
        type=$(get_field "$toml" "type")
        primary=$(get_field "$toml" "primary")

        # Apply filter
        case $filter in
            all) ;;
            active|archived|paused|completed)
                [ "$status" != "$filter" ] && continue
                ;;
            datakai|westmonroe|personal)
                [ "$primary" != "$filter" ] && continue
                ;;
            product|client-project|internal|experiment)
                [ "$type" != "$filter" ] && continue
                ;;
            *)
                print_error "Unknown filter: $filter"
                return 1
                ;;
        esac

        # Display
        project_name=$(basename "$project_path")
        status_color=$GREEN
        [ "$status" = "archived" ] && status_color=$YELLOW
        [ "$status" = "paused" ] && status_color=$CYAN

        echo -e "${BLUE}$project_name${NC}"
        echo "  Name: $name"
        echo -e "  Status: ${status_color}${status}${NC} | Type: $type | Owner: $primary"
        echo ""

        ((count++))
    done < <(find_all_projects)

    print_info "Total: $count projects"
}

# Show detailed project info
cmd_show() {
    local project_name="$1"

    if [ -z "$project_name" ]; then
        print_error "Project name required"
        echo "Usage: project show <name>"
        return 1
    fi

    # Find project
    local project_path=""
    if [ -d "$PROJECTS_DIR/$project_name" ]; then
        project_path="$PROJECTS_DIR/$project_name"
    elif [ -d "$ARCHIVE_DIR/$project_name" ]; then
        project_path="$ARCHIVE_DIR/$project_name"
    else
        print_error "Project '$project_name' not found"
        return 1
    fi

    # Use project-info helper
    project-info "$project_path"
}

# Search projects
cmd_search() {
    local query="$1"

    if [ -z "$query" ]; then
        print_error "Search query required"
        echo "Usage: project search <query>"
        return 1
    fi

    print_info "=== Search Results for: $query ==="
    echo ""

    local count=0
    while IFS= read -r project_path; do
        toml="$project_path/.project.toml"

        # Search in name, description, stack, domain
        if grep -qi "$query" "$toml" 2>/dev/null; then
            name=$(get_field "$toml" "name")
            status=$(get_field "$toml" "status")
            description=$(get_field "$toml" "description")

            project_name=$(basename "$project_path")
            echo -e "${BLUE}$project_name${NC}"
            echo "  $name ($status)"
            [ -n "$description" ] && echo "  $description"
            echo ""

            ((count++))
        fi
    done < <(find_all_projects)

    [ $count -eq 0 ] && print_warning "No projects found matching: $query"
    [ $count -gt 0 ] && print_info "Found: $count projects"
}

# Find projects by technology
cmd_find() {
    local tech="$1"

    if [ -z "$tech" ]; then
        print_error "Technology required"
        echo "Usage: project find <tech>"
        return 1
    fi

    print_info "=== Projects using: $tech ==="
    echo ""

    local count=0
    while IFS= read -r project_path; do
        toml="$project_path/.project.toml"

        stack=$(grep "^stack = " "$toml" 2>/dev/null | grep -i "$tech")
        if [ -n "$stack" ]; then
            name=$(get_field "$toml" "name")
            status=$(get_field "$toml" "status")

            project_name=$(basename "$project_path")
            echo -e "${BLUE}$project_name${NC} - $name ($status)"

            ((count++))
        fi
    done < <(find_all_projects)

    [ $count -eq 0 ] && print_warning "No projects found using: $tech"
    [ $count -gt 0 ] && print_info "Total: $count projects"
}

# List clients
cmd_clients() {
    print_info "=== Client Projects ==="
    echo ""

    # Collect all client projects
    local client_projects=""

    while IFS= read -r project_path; do
        toml="$project_path/.project.toml"

        type=$(get_field "$toml" "type")
        [ "$type" != "client-project" ] && continue

        end_client=$(get_field "$toml" "end_client")
        [ -z "$end_client" ] && continue

        project_name=$(basename "$project_path")
        name=$(get_field "$toml" "name")
        status=$(get_field "$toml" "status")

        client_projects="$client_projects$end_client|$project_name|$name|$status
"
    done < <(find_all_projects)

    # Display grouped by client
    local current_client=""
    echo "$client_projects" | sort | while IFS='|' read -r client proj_name name status; do
        [ -z "$client" ] && continue

        if [ "$client" != "$current_client" ]; then
            [ -n "$current_client" ] && echo ""
            echo -e "${GREEN}${client}${NC}"
            current_client="$client"
        fi

        echo "  - $proj_name: $name ($status)"
    done
}

# Show statistics
cmd_stats() {
    print_info "=== Project Statistics ==="
    echo ""

    local total=0
    local status_list=""
    local type_list=""
    local owner_list=""

    while IFS= read -r project_path; do
        toml="$project_path/.project.toml"

        status=$(get_field "$toml" "status")
        type=$(get_field "$toml" "type")
        primary=$(get_field "$toml" "primary")

        ((total++))
        status_list="$status_list$status
"
        type_list="$type_list$type
"
        owner_list="$owner_list$primary
"
    done < <(find_all_projects)

    echo "Total Projects: $total"
    echo ""

    echo "By Status:"
    echo "$status_list" | sort | uniq -c | sort -rn | while read count status; do
        [ -n "$status" ] && echo "  $status: $count"
    done
    echo ""

    echo "By Type:"
    echo "$type_list" | sort | uniq -c | sort -rn | while read count type; do
        [ -n "$type" ] && echo "  $type: $count"
    done
    echo ""

    echo "By Owner:"
    echo "$owner_list" | sort | uniq -c | sort -rn | while read count owner; do
        [ -n "$owner" ] && echo "  $owner: $count"
    done
}

# Validate project metadata
cmd_validate() {
    local target="$1"
    local errors=0

    print_info "=== Validating Project Metadata ==="
    echo ""

    if [ -n "$target" ]; then
        # Validate specific project
        if [ -d "$PROJECTS_DIR/$target" ]; then
            project_path="$PROJECTS_DIR/$target"
        elif [ -d "$ARCHIVE_DIR/$target" ]; then
            project_path="$ARCHIVE_DIR/$target"
        else
            print_error "Project '$target' not found"
            return 1
        fi

        validate_project "$project_path" && print_success "✓ $target" || ((errors++))
    else
        # Validate all projects
        while IFS= read -r project_path; do
            project_name=$(basename "$project_path")
            if validate_project "$project_path"; then
                print_success "✓ $project_name"
            else
                print_error "✗ $project_name"
                ((errors++))
            fi
        done < <(find_all_projects)
    fi

    echo ""
    [ $errors -eq 0 ] && print_success "All projects valid!" || print_error "$errors project(s) have errors"
    return $errors
}

validate_project() {
    local project_path="$1"
    local toml="$project_path/.project.toml"
    local valid=true

    # Check required fields
    local id=$(get_field "$toml" "id")
    local expected_id=$(basename "$project_path")

    if [ "$id" != "$expected_id" ]; then
        echo "  Error: ID '$id' doesn't match directory name '$expected_id'"
        valid=false
    fi

    # Check required fields exist
    for field in name status type primary; do
        local value=$(get_field "$toml" "$field")
        if [ -z "$value" ]; then
            echo "  Error: Missing required field: $field"
            valid=false
        fi
    done

    $valid
}

# Create new project
cmd_new() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Project name required"
        echo "Usage: project new <name>"
        return 1
    fi

    local project_path="$PROJECTS_DIR/$name"

    if [ -d "$project_path" ]; then
        print_error "Project '$name' already exists"
        return 1
    fi

    mkdir -p "$project_path"

    # Copy template if it exists
    if [ -f "$HOME/.config/templates/.project.toml" ]; then
        cp "$HOME/.config/templates/.project.toml" "$project_path/.project.toml"

        # Update ID to match directory name
        sed -i '' "s/id = \"project-directory-name\"/id = \"$name\"/" "$project_path/.project.toml"

        print_success "Created project: $name"
        echo "  Path: $project_path"
        echo "  Edit: project edit $name"
    else
        print_error "Template not found at ~/.config/templates/.project.toml"
        rmdir "$project_path"
        return 1
    fi
}

# Archive a project
cmd_archive() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Project name required"
        echo "Usage: project archive <name>"
        return 1
    fi

    local source="$PROJECTS_DIR/$name"
    local dest="$ARCHIVE_DIR/$name"

    if [ ! -d "$source" ]; then
        print_error "Project '$name' not found in projects/"
        return 1
    fi

    if [ -d "$dest" ]; then
        print_error "Project '$name' already exists in archive/"
        return 1
    fi

    # Move project
    mv "$source" "$dest"

    # Update status in metadata
    if [ -f "$dest/.project.toml" ]; then
        sed -i '' 's/status = "active"/status = "archived"/' "$dest/.project.toml"
        sed -i '' "s/completed = \"\"/completed = \"$(date +%Y-%m-%d)\"/" "$dest/.project.toml"
    fi

    print_success "Archived project: $name"
    echo "  New location: $dest"
}

# Edit project metadata
cmd_edit() {
    local name="$1"

    if [ -z "$name" ]; then
        print_error "Project name required"
        echo "Usage: project edit <name>"
        return 1
    fi

    local project_path=""
    if [ -d "$PROJECTS_DIR/$name" ]; then
        project_path="$PROJECTS_DIR/$name"
    elif [ -d "$ARCHIVE_DIR/$name" ]; then
        project_path="$ARCHIVE_DIR/$name"
    else
        print_error "Project '$name' not found"
        return 1
    fi

    ${EDITOR:-nvim} "$project_path/.project.toml"
}

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true

    case $command in
        list)       cmd_list "$@" ;;
        show)       cmd_show "$@" ;;
        search)     cmd_search "$@" ;;
        find)       cmd_find "$@" ;;
        clients)    cmd_clients "$@" ;;
        stats)      cmd_stats "$@" ;;
        validate)   cmd_validate "$@" ;;
        new)        cmd_new "$@" ;;
        archive)    cmd_archive "$@" ;;
        edit)       cmd_edit "$@" ;;
        help|--help|-h) show_usage ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            show_usage
            exit 1
            ;;
    esac
}

main "$@"
