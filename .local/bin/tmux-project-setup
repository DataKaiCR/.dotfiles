#!/usr/bin/env bash
# Tmux Project Setup - Create standardized window layouts for projects

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Help text
show_help() {
    cat << EOF
Usage: tmux-project-setup [PROJECT_DIR] [LAYOUT_TYPE]

Sets up a tmux session with a standardized window layout for a project.

PROJECT_DIR:    Path to project directory (default: current directory)
LAYOUT_TYPE:    Type of project layout (default: auto-detect)
                - webapp      Web application (frontend/backend)
                - dataeng     Data engineering project
                - infra       Infrastructure/DevOps project
                - knowledge   Knowledge processing (Obsidian/MCP)
                - basic       Basic 4-window layout

Examples:
    tmux-project-setup ~/projects/datakai/cert-study-platform webapp
    tmux-project-setup ~/projects/trulieve/tdp-sap-msk dataeng
    tmux-project-setup . basic

If no layout type is specified, the script will try to auto-detect based on
project files (package.json, requirements.txt, docker-compose.yml, etc.)
EOF
}

# Parse arguments
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

PROJECT_DIR="${1:-.}"
LAYOUT_TYPE="$2"

# Resolve to absolute path
PROJECT_DIR=$(cd "$PROJECT_DIR" && pwd)
PROJECT_NAME=$(basename "$PROJECT_DIR")
SESSION_NAME=$(echo "$PROJECT_NAME" | tr . _)

echo -e "${BLUE}Setting up tmux session for: ${GREEN}$PROJECT_NAME${NC}"

# Auto-detect project type if not specified
if [[ -z "$LAYOUT_TYPE" ]]; then
    echo -e "${YELLOW}Auto-detecting project type...${NC}"

    # Check for knowledge vault (Obsidian + MCP)
    if [[ -d "$PROJECT_DIR/.obsidian" ]] || [[ "$PROJECT_DIR" == *"scriptorium"* ]]; then
        LAYOUT_TYPE="knowledge"
        echo -e "${GREEN}Detected: Knowledge Vault${NC}"
    elif [[ -f "$PROJECT_DIR/package.json" ]]; then
        LAYOUT_TYPE="webapp"
        echo -e "${GREEN}Detected: Web Application${NC}"
    elif [[ -f "$PROJECT_DIR/requirements.txt" ]] || [[ -f "$PROJECT_DIR/setup.py" ]] || [[ -f "$PROJECT_DIR/pyproject.toml" ]]; then
        # Check if it's data engineering related
        if grep -q "spark\|airflow\|kafka\|databricks\|snowflake" "$PROJECT_DIR/requirements.txt" 2>/dev/null; then
            LAYOUT_TYPE="dataeng"
            echo -e "${GREEN}Detected: Data Engineering${NC}"
        else
            LAYOUT_TYPE="webapp"
            echo -e "${GREEN}Detected: Python Application${NC}"
        fi
    elif [[ -f "$PROJECT_DIR/docker-compose.yml" ]] || [[ -d "$PROJECT_DIR/terraform" ]] || [[ -d "$PROJECT_DIR/infrastructure" ]]; then
        LAYOUT_TYPE="infra"
        echo -e "${GREEN}Detected: Infrastructure/DevOps${NC}"
    else
        LAYOUT_TYPE="basic"
        echo -e "${YELLOW}Using: Basic Layout${NC}"
    fi
fi

# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo -e "${YELLOW}Session '$SESSION_NAME' already exists!${NC}"
    echo -e "Options:"
    echo -e "  1) Attach to existing session (keeps current layout)"
    echo -e "  2) Kill and recreate (WARNING: loses current state)"
    echo -e "  3) Cancel"
    read -p "Choose [1-3]: " choice

    case $choice in
        1)
            if [[ -n "$TMUX" ]]; then
                tmux switch-client -t "$SESSION_NAME"
            else
                tmux attach-session -t "$SESSION_NAME"
            fi
            exit 0
            ;;
        2)
            tmux kill-session -t "$SESSION_NAME"
            ;;
        *)
            echo "Cancelled."
            exit 0
            ;;
    esac
fi

# Function to create webapp layout
setup_webapp() {
    echo -e "${BLUE}Creating Web Application layout...${NC}"

    # Create session with first window
    tmux new-session -d -s "$SESSION_NAME" -n "code" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:1" "nvim ." C-m

    # Window 2: Claude
    tmux new-window -t "$SESSION_NAME:2" -n "claude" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:2" "# Claude Code window - run: claude" C-m

    # Window 3: Server
    tmux new-window -t "$SESSION_NAME:3" -n "server" -c "$PROJECT_DIR"
    if [[ -f "$PROJECT_DIR/package.json" ]]; then
        tmux send-keys -t "$SESSION_NAME:3" "# Run dev server: npm run dev" C-m
    elif [[ -f "$PROJECT_DIR/manage.py" ]]; then
        tmux send-keys -t "$SESSION_NAME:3" "# Run dev server: python manage.py runserver" C-m
    elif [[ -f "$PROJECT_DIR/main.py" ]] || [[ -f "$PROJECT_DIR/app.py" ]]; then
        tmux send-keys -t "$SESSION_NAME:3" "# Run dev server: uvicorn main:app --reload" C-m
    fi

    # Window 4: Test
    tmux new-window -t "$SESSION_NAME:4" -n "test" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:4" "# Run tests here" C-m

    # Window 5: Docker (if docker-compose exists)
    if [[ -f "$PROJECT_DIR/docker-compose.yml" ]]; then
        tmux new-window -t "$SESSION_NAME:5" -n "docker" -c "$PROJECT_DIR"
        tmux send-keys -t "$SESSION_NAME:5" "# docker-compose up" C-m
    fi
}

# Function to create data engineering layout
setup_dataeng() {
    echo -e "${BLUE}Creating Data Engineering layout...${NC}"

    # Create session
    tmux new-session -d -s "$SESSION_NAME" -n "code" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:1" "nvim ." C-m

    # Window 2: Claude
    tmux new-window -t "$SESSION_NAME:2" -n "claude" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:2" "# Claude Code window" C-m

    # Window 3: Services (Kafka/Airflow/Spark)
    tmux new-window -t "$SESSION_NAME:3" -n "services" -c "$PROJECT_DIR"
    if [[ -f "$PROJECT_DIR/docker-compose.yml" ]]; then
        tmux send-keys -t "$SESSION_NAME:3" "# docker-compose up -d" C-m
    fi

    # Window 4: AWS/Cloud
    tmux new-window -t "$SESSION_NAME:4" -n "cloud" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:4" "# AWS CLI / Databricks CLI / Terraform" C-m

    # Window 5: Logs/Monitoring
    tmux new-window -t "$SESSION_NAME:5" -n "logs" -c "$PROJECT_DIR"
    if [[ -f "$PROJECT_DIR/docker-compose.yml" ]]; then
        tmux send-keys -t "$SESSION_NAME:5" "# docker-compose logs -f" C-m
    fi

    # Window 6: Test
    tmux new-window -t "$SESSION_NAME:6" -n "test" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:6" "# pytest or integration tests" C-m
}

# Function to create infrastructure layout
setup_infra() {
    echo -e "${BLUE}Creating Infrastructure/DevOps layout...${NC}"

    # Create session
    tmux new-session -d -s "$SESSION_NAME" -n "code" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:1" "nvim ." C-m

    # Window 2: Claude
    tmux new-window -t "$SESSION_NAME:2" -n "claude" -c "$PROJECT_DIR"

    # Window 3: Terraform/IaC
    tmux new-window -t "$SESSION_NAME:3" -n "terraform" -c "$PROJECT_DIR"
    if [[ -d "$PROJECT_DIR/terraform" ]]; then
        tmux send-keys -t "$SESSION_NAME:3" "cd terraform" C-m
    fi
    tmux send-keys -t "$SESSION_NAME:3" "# terraform plan / apply" C-m

    # Window 4: Docker
    tmux new-window -t "$SESSION_NAME:4" -n "docker" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:4" "# docker-compose up / docker ps" C-m

    # Window 5: Monitoring
    tmux new-window -t "$SESSION_NAME:5" -n "monitor" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:5" "# kubectl / aws / docker logs" C-m
}

# Function to create knowledge processing layout
setup_knowledge() {
    echo -e "${BLUE}Creating Knowledge Processing layout...${NC}"

    # Create session with Obsidian/editing window
    tmux new-session -d -s "$SESSION_NAME" -n "vault" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:1" "nvim ." C-m

    # Window 2: Claude with MCP
    tmux new-window -t "$SESSION_NAME:2" -n "claude" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:2" "# AI knowledge processing - run: claude" C-m
    tmux send-keys -t "$SESSION_NAME:2" "# MCP commands available via /scriptoria" C-m

    # Window 3: MCP Server (if scriptoria-mcp exists)
    if [[ -d "$PROJECT_DIR/scriptoria-mcp" ]] || [[ -d "$PROJECT_DIR/scriptorium-mcp" ]]; then
        tmux new-window -t "$SESSION_NAME:3" -n "mcp-server" -c "$PROJECT_DIR"
        if [[ -d "$PROJECT_DIR/scriptoria-mcp" ]]; then
            tmux send-keys -t "$SESSION_NAME:3" "cd scriptoria-mcp" C-m
        fi
        tmux send-keys -t "$SESSION_NAME:3" "# MCP server development" C-m
        tmux send-keys -t "$SESSION_NAME:3" "# source .venv/bin/activate" C-m
    else
        tmux new-window -t "$SESSION_NAME:3" -n "process" -c "$PROJECT_DIR"
        tmux send-keys -t "$SESSION_NAME:3" "# Knowledge processing workspace" C-m
    fi

    # Window 4: Journal/Inbox
    tmux new-window -t "$SESSION_NAME:4" -n "inbox" -c "$PROJECT_DIR"
    if [[ -d "$PROJECT_DIR/00-inbox" ]]; then
        tmux send-keys -t "$SESSION_NAME:4" "cd 00-inbox" C-m
    fi
    tmux send-keys -t "$SESSION_NAME:4" "# Quick capture and inbox processing" C-m

    # Window 5: Zettelkasten
    if [[ -d "$PROJECT_DIR/zettelkasten" ]]; then
        tmux new-window -t "$SESSION_NAME:5" -n "zettel" -c "$PROJECT_DIR/zettelkasten"
        tmux send-keys -t "$SESSION_NAME:5" "# Permanent notes" C-m
    fi

    # Window 6: Search/Grep
    tmux new-window -t "$SESSION_NAME:6" -n "search" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:6" "# Search vault: rg 'pattern' or fzf" C-m
}

# Function to create basic layout
setup_basic() {
    echo -e "${BLUE}Creating Basic layout...${NC}"

    # Create session
    tmux new-session -d -s "$SESSION_NAME" -n "code" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:1" "nvim ." C-m

    # Window 2: Claude
    tmux new-window -t "$SESSION_NAME:2" -n "claude" -c "$PROJECT_DIR"
    tmux send-keys -t "$SESSION_NAME:2" "# Run: claude" C-m

    # Window 3: Run
    tmux new-window -t "$SESSION_NAME:3" -n "run" -c "$PROJECT_DIR"

    # Window 4: Test
    tmux new-window -t "$SESSION_NAME:4" -n "test" -c "$PROJECT_DIR"
}

# Execute appropriate setup function
case $LAYOUT_TYPE in
    webapp)
        setup_webapp
        ;;
    dataeng)
        setup_dataeng
        ;;
    infra)
        setup_infra
        ;;
    knowledge)
        setup_knowledge
        ;;
    basic)
        setup_basic
        ;;
    *)
        echo -e "${YELLOW}Unknown layout type: $LAYOUT_TYPE${NC}"
        echo "Using basic layout..."
        setup_basic
        ;;
esac

# Select the first window (code)
tmux select-window -t "$SESSION_NAME:1"

echo -e "${GREEN}âœ“ Session '$SESSION_NAME' created with $LAYOUT_TYPE layout${NC}"
echo -e "${BLUE}Windows:${NC}"
tmux list-windows -t "$SESSION_NAME" -F "  #{window_index}: #{window_name}"

# Attach or switch to the session
if [[ -n "$TMUX" ]]; then
    echo -e "\n${YELLOW}Switching to session...${NC}"
    tmux switch-client -t "$SESSION_NAME"
else
    echo -e "\n${YELLOW}Attaching to session...${NC}"
    tmux attach-session -t "$SESSION_NAME"
fi
