#!/usr/bin/env bash
# Tmux Sessionizer - Quickly jump to projects and create/attach sessions
# Inspired by ThePrimeagen workflows
# Optimized with caching for instant startup

# Define top-level directories to search
SEARCH_DIRS=(
    "$HOME/projects"
    "$HOME/archive"
    "$HOME/scriptorium"
    "$HOME/.config"
)

# Cache configuration
CACHE_FILE="${TMPDIR:-/tmp}/tmux-sessionizer-cache-$USER"
CACHE_MAX_AGE=3600  # 1 hour in seconds (adjust as needed)

# Helper to extract metadata field from TOML
get_metadata() {
    local toml_file="$1"
    local field="$2"
    grep "^$field = " "$toml_file" 2>/dev/null | sed "s/$field = \"\(.*\)\"/\1/" || echo ""
}

# Fast project discovery with caching
build_project_list() {
    local cache_valid=false

    # Check if cache exists and is recent
    if [[ -f "$CACHE_FILE" ]]; then
        local cache_age=$(($(date +%s) - $(stat -f %m "$CACHE_FILE" 2>/dev/null || echo 0)))
        if [[ $cache_age -lt $CACHE_MAX_AGE ]]; then
            cache_valid=true
        fi
    fi

    # Use cache if valid, otherwise rebuild
    if [[ "$cache_valid" == true ]]; then
        cat "$CACHE_FILE"
    else
        # Rebuild cache (runs in background for next time)
        (
            # Use fd if available (much faster), otherwise use find
            if command -v fd &>/dev/null; then
                fd -HI -t d '^\.git$' "${SEARCH_DIRS[@]}" 2>/dev/null | sed 's|/\.git/$||'
            else
                find "${SEARCH_DIRS[@]}" -name ".git" -type d -prune 2>/dev/null | sed 's|/\.git||'
            fi | \
            grep -v "/tmux/plugins/" | \
            while read -r project_path; do
                dir_name=$(basename "$project_path")
                if [[ -f "$project_path/.project.toml" ]]; then
                    proj_name=$(get_metadata "$project_path/.project.toml" "name")
                    proj_status=$(get_metadata "$project_path/.project.toml" "status")
                    proj_owner=$(get_metadata "$project_path/.project.toml" "primary")

                    printf "%s|%s|%s|%s|%s\n" \
                        "$project_path" \
                        "$dir_name" \
                        "${proj_name:-$dir_name}" \
                        "${proj_status:-unknown}" \
                        "${proj_owner:-none}"
                else
                    printf "%s|%s|%s|%s|%s\n" \
                        "$project_path" \
                        "$dir_name" \
                        "$dir_name" \
                        "-" \
                        "-"
                fi
            done | sort -t'|' -k2 > "$CACHE_FILE.tmp"
            mv "$CACHE_FILE.tmp" "$CACHE_FILE"
        ) &

        # For first run, wait for cache to build
        if [[ ! -f "$CACHE_FILE" ]]; then
            wait
        fi
        cat "$CACHE_FILE" 2>/dev/null || echo ""
    fi
}

# If argument provided, use it as the selected directory
if [[ $# -eq 1 ]]; then
    selected=$1
else
    # Build project list (from cache if available)
    project_list=$(build_project_list)

    # Use fzf to select with searchable metadata
    # Display format with tabs: "dir_name\t[owner]\tstatus"
    selected=$(echo "$project_list" | \
        awk -F'|' '{printf "%s\t[%s]\t%s\n", $2, $5, $4}' | fzf \
        --height 60% \
        --reverse \
        --border \
        --ansi \
        --tabstop=40 \
        --prompt="⚡ Project: " \
        --preview 'echo {}' \
        --preview-window=right:50%:wrap \
        --preview-label="[ Quick Select ]" \
        | cut -f1
    )

    # Extract the full path from the project_list using the selected dir name
    if [[ -n "$selected" ]]; then
        selected=$(echo "$project_list" | grep "|$selected|" | head -1 | cut -d'|' -f1)
    fi
fi

# Exit if nothing selected
if [[ -z $selected ]]; then
    exit 0
fi

# Create session name from directory (replace dots with underscores)
selected_name=$(basename "$selected" | tr . _)

# Auto-switch cloud context based on .project.toml
if [[ -f "$selected/.project.toml" ]]; then
    owner=$(grep 'primary.*=' "$selected/.project.toml" | sed 's/.*"\(.*\)".*/\1/')

    if [[ -n "$owner" ]]; then
        # Export environment variables for cloud context
        export AWS_PROFILE="$owner"
        export DATABRICKS_CONFIG_PROFILE="$owner"

        # Switch Azure subscription (if cloud-switcher is loaded)
        if type azsp &>/dev/null; then
            case "$owner" in
                datakai)
                    azsp "DataKai Development" &>/dev/null
                    ;;
                westmonroe)
                    azsp "West Monroe Sandbox" &>/dev/null
                    ;;
                express)
                    azsp "Express Pros Prod" &>/dev/null
                    ;;
            esac
        fi

        # Show notification of cloud context switch
        echo "☁️  Switched cloud context to: $owner"
        echo "   AWS: $AWS_PROFILE"
        echo "   Databricks: $DATABRICKS_CONFIG_PROFILE"
    fi
fi

# Check if session exists
if tmux has-session -t="$selected_name" 2>/dev/null; then
    # Session exists, just switch to it
    if [[ -z $TMUX ]]; then
        tmux attach-session -t "$selected_name"
    else
        tmux switch-client -t "$selected_name"
    fi
else
    # Session doesn't exist - offer to use project-setup or basic session
    echo "Session '$selected_name' doesn't exist yet."
    echo ""
    echo "Create with:"
    echo "  1) Auto-detected layout (recommended)"
    echo "  2) Basic session (single window)"
    echo "  3) Cancel"
    echo ""
    read -p "Choose [1-3] (default: 1): " choice
    choice=${choice:-1}

    case $choice in
        1)
            # Use the project-setup script
            exec tmux-project-setup "$selected"
            ;;
        2)
            # Create basic session
            if [[ -z $TMUX ]]; then
                tmux new-session -s "$selected_name" -c "$selected"
            else
                tmux new-session -ds "$selected_name" -c "$selected"
                tmux switch-client -t "$selected_name"
            fi
            ;;
        *)
            echo "Cancelled."
            exit 0
            ;;
    esac
fi
